name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libmagickwand-dev \
          libyaml-dev \
          libvips42 \
          gnuplot \
          x11-xserver-utils \
          protobuf-compiler \
          ffmpeg \
          xdg-utils

    - name: Install libTorch
      run: |
        # Download and install libTorch
        wget https://download.pytorch.org/libtorch/cu130/libtorch-shared-with-deps-2.10.0%2Bcu130.zip
        unzip libtorch-cxx11-abi-shared-with-deps-2.10.0+cu130.zip -d ../libtorch
        echo "LIBTORCH_PATH=../libtorch/libtorch" >> $GITHUB_ENV

    - name: Clone and modify torchvision-ruby repository
      run: |
        git clone https://github.com/ankane/torchvision-ruby.git ../torchvision-ruby
        # Modify torchvision-ruby Gemfile to use numo-narray-alt instead of numo-narray
        sed -i 's/gem "numo-narray"/gem "numo-narray-alt"/' ../torchvision-ruby/Gemfile

    - name: Configure bundle for torch-rb
      run: bundle config set --local build.torch-rb --with-torch-dir=${{ env.LIBTORCH_PATH }}

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4.8'
        bundler: '4'
        bundler-cache: true

    - name: Install dependencies
      run: bundle install

    - name: Run tests
      run: bundle exec rspec --format documentation
