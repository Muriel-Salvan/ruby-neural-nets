#!/usr/bin/env ruby

# TODO: Find why do I need that?
$LOAD_PATH.unshift(File.expand_path("#{__dir__}/../lib"))

# Make it easy to debug
require 'byebug'

# Get all options from CLI
require 'ruby_neural_nets/options'
options = RubyNeuralNets::Options.new
options.parse_cli

# Set debug mode for Logger
require 'ruby_neural_nets/logger'
RubyNeuralNets::Logger.debug_mode = options[:debug]

require 'numo/gnuplot'
require 'numo/narray'

require 'ruby_neural_nets/helpers'
RubyNeuralNets::Helpers.init(
  model_seed: options[:model_seed],
  instability_checks: options[:instability_checks]
)

require 'ruby_neural_nets/logger'
include RubyNeuralNets::Logger

# Create the progress tracker for all experiments
require 'ruby_neural_nets/progress_tracker'
progress_tracker = RubyNeuralNets::ProgressTracker.new(display_graphs: options[:display_graphs])

# Instantiate all inference experiments
require 'ruby_neural_nets/experiment'
require 'ruby_neural_nets/profiler'
experiments = []
options.experiments.each do |exp_info|
  # Load data from the dataset
  data_loader = options.instantiate(exp_info[:data_loader])
  dataset = data_loader.dataset(:training)

  # Display some stats
  puts "===== Preparing inference experiment #{exp_info[:exp_id][:value]}:"
  labels = data_loader.labels
  data_loader.display_stats
  # data_loader.display_sample(:test, labels.first)
  image_stats = data_loader.image_stats
  puts "Images size: #{image_stats[:rows]} x #{image_stats[:cols]} x #{image_stats[:channels]}"
  puts

  # Create the model
  model = options.instantiate(exp_info[:model], image_stats[:rows], image_stats[:cols], image_stats[:channels], labels.size)
  require 'json'
  puts "Model statistics:\n#{JSON.pretty_generate(model.stats)}"

  # Create inference experiment with nil values for training-specific components
  experiments << RubyNeuralNets::Experiment.new(
    exp_id: RubyNeuralNets.unique_experiment_id("#{exp_info[:exp_id][:value]}_inference", experiments),
    dataset: dataset,
    training_mode: false, # Always false for inference
    accuracy: nil, # No accuracy needed for inference
    data_loader: data_loader,
    loss: nil, # No loss needed for inference
    model: model,
    optimizer: nil, # No optimizer needed for inference
    nbr_epochs: 1, # Just one pass through data for inference
    gradient_checker: nil, # No gradient checking for inference
    profiler: RubyNeuralNets::Profiler.new(profiling: exp_info[:profiling][:value]),
    display_units: {},
    display_samples: exp_info[:display_samples][:value],
    dev_experiment: nil,
    dump_minibatches: exp_info[:dump_minibatches][:value],
    early_stopping_patience: nil # No early stopping for inference
  )
end

# Track the progress of all inference experiments
experiments.each { |experiment| progress_tracker.track(experiment) }

require 'ruby_neural_nets/inferer'
inferer = RubyNeuralNets::Inferer.new

# Run inference on all experiments
puts "===== Running inference on #{experiments.size} experiment(s)..."
progress_tracker.session do
  experiments.each do |experiment|
    inferer.infer(experiment, 0) do |minibatch, a, idx_minibatch|
      # Here we could process the inferred data if needed
      # For now, we just let the Inferer handle the forward propagation
      log "Experiment #{experiment.exp_id} infered data for minibatch #{idx_minibatch}: #{data_to_str(a)}"
      puts 'Displaying source image...'
      RubyNeuralNets::Helpers.display_image(RubyNeuralNets::Helpers.tensor_to_image(minibatch.each_element.first[0]))
      puts 'Displaying inferred image...'
      RubyNeuralNets::Helpers.display_image(RubyNeuralNets::Helpers.tensor_to_image(a[0]))
    end
  end
end

# Close graphs
# progress_tracker.close_graphs

puts '===== Inference completed.'
